@{
    Layout = "_Layout";
}

<div class="chat-container">
    <div class="chat-header">
        <h3>Общий чат</h3>
        <div id="online-count">Онлайн: 0</div>
    </div>

    <div class="messages-container" id="messagesContainer">
        <!-- Сообщения будут добавляться здесь -->
    </div>

    <div class="message-input">
        <input type="text" id="messageInput" placeholder="Введите сообщение..." />
        <button id="sendButton">Отправить</button>
    </div>
</div>

<!-- Подключите SignalR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>

<style>
    .chat-container {
        max-width: 800px;
        margin: 0 auto;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
        height: 80vh;
        display: flex;
        flex-direction: column;
    }

    .chat-header {
        background: #007bff;
        color: white;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
    }

    .message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 15px;
        max-width: 70%;
        word-wrap: break-word;
    }

    .message-sent {
        background: #007bff;
        color: white;
        margin-left: auto;
    }

    .message-received {
        background: #e9ecef;
        margin-right: auto;
    }

    .message-header {
        font-size: 0.8em;
        opacity: 0.8;
        margin-bottom: 5px;
    }

    .message-input {
        display: flex;
        padding: 15px;
        background: white;
        border-top: 1px solid #ddd;
    }

    #messageInput {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 20px;
        margin-right: 10px;
    }

    #sendButton {
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
    }
</style>

<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chatHub")
        .configureLogging(signalR.LogLevel.Information)
        .build();

    // Получение сообщений
    connection.on("ReceiveMessage", (user, message, timestamp) => {
        const messagesContainer = document.getElementById('messagesContainer');
        const messageElement = document.createElement('div');
        messageElement.className = `message ${user === '@User.Identity?.Name' ? 'message-sent' : 'message-received'}`;

        const time = new Date(timestamp).toLocaleTimeString();
        messageElement.innerHTML = `
            <div class="message-header">
                <strong>${user}</strong>
                <span>${time}</span>
            </div>
            <div class="message-content">${message}</div>
        `;

        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    });

    // Подключение пользователей
    connection.on("UserJoined", (userId) => {
        console.log(`${userId} присоединился к чату`);
    });

    connection.on("UserLeft", (userId) => {
        console.log(`${userId} покинул чат`);
    });

    // Запуск подключения
    async function start() {
        try {
            await connection.start();
            console.log("Connected to SignalR hub");

            // Загружаем историю сообщений
            loadMessageHistory();

        } catch (err) {
            console.error(err);
            setTimeout(start, 5000);
        }
    }

    // Отправка сообщения
    document.getElementById('sendButton').addEventListener('click', async () => {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();

        if (message) {
            try {
                await connection.invoke("SendMessage", '@User.Identity?.Name', message);
                messageInput.value = '';
            } catch (err) {
                console.error(err);
            }
        }
    });

    // Отправка по Enter
    document.getElementById('messageInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            document.getElementById('sendButton').click();
        }
    });

    // Загрузка истории сообщений
    async function loadMessageHistory() {
        try {
            const response = await fetch('/Chat/GetMessageHistory');
            const messages = await response.json();

            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';

            messages.forEach(msg => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${msg.senderUsername === '@User.Identity?.Name' ? 'message-sent' : 'message-received'}`;
                messageElement.innerHTML = `
                    <div class="message-header">
                        <strong>${msg.senderUsername}</strong>
                        <span>${new Date(msg.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="message-content">${msg.content}</div>
                `;
                container.appendChild(messageElement);
            });

            container.scrollTop = container.scrollHeight;
        } catch (err) {
            console.error('Error loading message history:', err);
        }
    }

    // Стартуем подключение
    start();

    // При закрытии вкладки
    window.addEventListener('beforeunload', () => {
        connection.stop();
    });
</script>