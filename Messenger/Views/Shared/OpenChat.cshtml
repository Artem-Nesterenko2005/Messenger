@using System.Security.Claims
@model ChatViewModel

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>SignalR Chat - @Model.InterlocutorId</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.13/signalr.min.js"></script>
    <script src="~/js/chat.js"></script>
</head>
<body>
    <div id="chat-container">
        <div id="messages-list">
            @foreach (var message in Model.Messages)
            {
                <div id="@message.Id" class="message @(message.SenderId == Model.MyId ? "my-message" : "their-message")">
                    <strong>@message.SenderName:</strong> @message.Content
                </div>
            }
        </div>

        <div>
            <input type="hidden" id="recipientId" value="@Model.InterlocutorId" />
            <input type="hidden" id="myId" value="@Model.MyId" />
            <input id="messageInput" placeholder="Введите сообщение" type="text" />
            <button id="sendButton">Отправить</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatClient = new ChatClient({
                recipientId: document.getElementById('recipientId').value,
                myId: document.getElementById('myId').value,
                messageInputId: '#messageInput',
                sendButtonId: '#sendButton',
                messagesListId: '#messages-list',
                hubUrl: '/chatHub'
            });
        });
    </script>

    <script>
        const interlocutorIdFromModel = '@Model.InterlocutorId';

        document.getElementById('messages-list')?.addEventListener('contextmenu', function(event) {
            const myMessageElement = event.target.closest('.message.my-message[id]');

            if (myMessageElement) {
                event.preventDefault();
                handleMyMessageRightClick(event, myMessageElement);
            }
        });

        async function handleMyMessageRightClick(event, element) {
            if (confirm('Удалить ваше сообщение?')) {
                try {
                    const response = await fetch(`/DeleteMessage?messageId=${element.id}&interlocutorId=${interlocutorIdFromModel}`, {
                        method: 'DELETE',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (response.ok) {
                        alert('Ваше сообщение удалено!');
                        element.remove();
                    } else {
                        alert('Ошибка при удалении: ' + response.status);
                    }
                } catch (error) {
                    console.error('Ошибка сети:', error);
                    alert('Ошибка сети');
                }
            }
        }
    </script>
</body>
</html>